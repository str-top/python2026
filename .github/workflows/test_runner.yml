name: Test Runner (Student Starter)

on:
  discussion_comment:
    types: [created, edited]

jobs:
  call-central-runner:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: read

    steps:
      - name: Checkout student repo
        uses: actions/checkout@v4

      - name: Resolve test metadata from link file
        id: meta
        shell: python
        env:
          DISCUSSION_NODE_ID: ${{ github.event.discussion.node_id }}
        run: |
          import os
          import re
          import sys
          from pathlib import Path

          discussion_node_id = os.environ.get('DISCUSSION_NODE_ID', '').strip()
          if not discussion_node_id:
            raise SystemExit('DISCUSSION_NODE_ID missing from event')

          # Find any link file containing the node id.
          candidates = list(Path('lessons').glob('lesson */tests/test *.md'))
          if not candidates:
            raise SystemExit('No test link files found under lessons/*/tests/')

          selected = None
          content = None
          for p in candidates:
            try:
              txt = p.read_text(encoding='utf-8')
            except Exception:
              continue
            if f'discussion_node_id: {discussion_node_id}' in txt:
              selected = p
              content = txt
              break

          if not selected:
            raise SystemExit('No link file matches this discussion_node_id')

          def grab(key: str) -> str:
            m = re.search(rf'^\s*{re.escape(key)}:\s*(.+?)\s*$', content, flags=re.MULTILINE)
            return (m.group(1).strip() if m else '')

          test_number = grab('test_number')
          lesson_number = grab('lesson_number')
          lesson_folder = grab('lesson_folder')
          student_short = grab('student_short')
          student_github = grab('student_github')
          teacher_marker_login = grab('teacher_marker_login')
          tracker_discussion_id = grab('tracker_discussion_id')
          tracker_comment_id = grab('tracker_comment_id')

          missing = [k for k,v in {
            'test_number': test_number,
            'lesson_number': lesson_number,
            'lesson_folder': lesson_folder,
            'student_short': student_short,
            'student_github': student_github,
            'teacher_marker_login': teacher_marker_login,
            'tracker_discussion_id': tracker_discussion_id,
            'tracker_comment_id': tracker_comment_id,
          }.items() if not v]
          if missing:
            raise SystemExit(f'Missing fields in link file {selected}: {missing}')

          out = os.environ.get('GITHUB_OUTPUT')
          with open(out, 'a', encoding='utf-8') as f:
            f.write(f'test_number={test_number}\n')
            f.write(f'lesson_number={lesson_number}\n')
            f.write(f'lesson_folder={lesson_folder}\n')
            f.write(f'student_short={student_short}\n')
            f.write(f'student_github={student_github}\n')
            f.write(f'discussion_node_id={discussion_node_id}\n')
            f.write(f'teacher_marker_login={teacher_marker_login}\n')
            f.write(f'tracker_discussion_id={tracker_discussion_id}\n')
            f.write(f'tracker_comment_id={tracker_comment_id}\n')

      - name: Call centralized test runner
        uses: Pau1R/python2026_tasks/.github/workflows/test_runner.yml@main
        with:
          test_number: ${{ steps.meta.outputs.test_number }}
          lesson_folder: ${{ steps.meta.outputs.lesson_folder }}
          lesson_number: ${{ steps.meta.outputs.lesson_number }}
          student_short: ${{ steps.meta.outputs.student_short }}
          student_github: ${{ steps.meta.outputs.student_github }}
          discussion_node_id: ${{ steps.meta.outputs.discussion_node_id }}
          teacher_marker_login: ${{ steps.meta.outputs.teacher_marker_login }}
          tracker_discussion_id: ${{ steps.meta.outputs.tracker_discussion_id }}
          tracker_comment_id: ${{ steps.meta.outputs.tracker_comment_id }}
        secrets:
          TEACHER_PAT: ${{ secrets.TEACHER_PAT }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
